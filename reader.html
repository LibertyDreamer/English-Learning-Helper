<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Reader</title>
  <link rel="stylesheet" href="reading.css">
</head>
<body>
  <div id="container">
    <h1>Reader</h1>
    
    <div id="intro">
      <p>Enter your Azure API key.</p>
      <input id="pat" placeholder="Enter your Azure OpenAI PAT" />
    </div>
    
    <div id="game-area">
      <div id="story"></div>
      <button type="button">Load book.</button>
    </div>
  </div>

  <!-- Inline JavaScript to load text file content into the story div -->
   <script type="module">
  import { makeWordsClickable } from './clickableWords.js';
  import { callOpenAI } from './openaiCaller.js';



function fuu(word, lang = "en-US") {
    const tinkoffTTS = `https://voice.tinkoff.ru/synthesize?text=${encodeURIComponent(word)}&voice=oksana&format=mp3`;

    let audio = new Audio(tinkoffTTS);
    audio.play();
}

fuu("HELLO WORLD");









function showAlertWithMeaning(word, meaning) {
    // Remove existing modal if any
    let existingModal = document.getElementById("custom-alert");
    if (existingModal) {
        document.body.removeChild(existingModal);
    }

    // Create modal container
    let modal = document.createElement("div");
    modal.id = "custom-alert";
    modal.style.position = "fixed";
    modal.style.top = "50%";
    modal.style.left = "50%";
    modal.style.transform = "translate(-50%, -50%)";
    modal.style.width = "400px";
    modal.style.padding = "15px";
    modal.style.backgroundColor = "#222";  // Dark theme
    modal.style.color = "#eee";
    modal.style.border = "1px solid #444";
    modal.style.boxShadow = "0 4px 10px rgba(0, 0, 0, 0.3)";
    modal.style.borderRadius = "8px";
    modal.style.fontFamily = "Arial, sans-serif";
    modal.style.textAlign = "center";
    modal.style.zIndex = "1000";

    // Word title
    let wordTitle = document.createElement("h2");
    wordTitle.textContent = word;
    wordTitle.style.marginBottom = "10px";
    modal.appendChild(wordTitle);

    // Meaning text
    let meaningText = document.createElement("p");
    meaningText.textContent = meaning;
    meaningText.style.fontSize = "14px";
    meaningText.style.lineHeight = "1.4";
    meaningText.style.marginBottom = "15px";
    modal.appendChild(meaningText);

    // Buttons container
    let buttonsContainer = document.createElement("div");
    buttonsContainer.style.display = "flex";
    buttonsContainer.style.justifyContent = "center";
    buttonsContainer.style.gap = "10px";

    // Play Button
    let playButton = document.createElement("button");
    playButton.textContent = "ðŸ”Š Play";
    playButton.style.padding = "8px 15px";
    playButton.style.border = "none";
    playButton.style.backgroundColor = "#444";
    playButton.style.color = "#fff";
    playButton.style.cursor = "pointer";
    playButton.style.borderRadius = "5px";
    playButton.onclick = function () {
        fuu(word);
    };
    buttonsContainer.appendChild(playButton);

    // Close Button
    let closeButton = document.createElement("button");
    closeButton.textContent = "Close";
    closeButton.style.padding = "8px 15px";
    closeButton.style.border = "none";
    closeButton.style.backgroundColor = "#777";
    closeButton.style.color = "#fff";
    closeButton.style.cursor = "pointer";
    closeButton.style.borderRadius = "5px";
    closeButton.onclick = function () {
        document.body.removeChild(modal);
    };
    buttonsContainer.appendChild(closeButton);

    modal.appendChild(buttonsContainer);

    // Append to body
    document.body.appendChild(modal);
}

  async function getResponse(word, context) {
    // Assuming "pat" is an input field, use .value
    const pat = document.getElementById("pat").value;
    const messages = [
      {
        role: 'system',
        content: `You are a dictionary. Explain meaning of this word or words inside this exact context.
It should be A0-A1 explanation like for kids but it's for adult. Add IPA.`
      },
      {
        role: 'user',
        content: `Word: "${word}" Context: "${context}"`
      }
    ];

    try {
      const aiMessage = await callOpenAI(messages, pat);
      showAlertWithMeaning(word, `${aiMessage}`);
    } catch (err) {
      alert(`${err}`);
    }
  }

  function handleWordClick(clickedWord, context) {
    getResponse(clickedWord, context);
  }

  // Find the button element on the page
  const loadButton = document.querySelector("button");

  // Create a hidden file input element
  const fileInput = document.createElement("input");
  fileInput.type = "file";
  fileInput.accept = ".txt"; // Accept only text files
  fileInput.style.display = "none"; // Hide the element

  // Append the file input to the document body so it can work properly
  document.body.appendChild(fileInput);

  // When the button is clicked, simulate a click on the file input
  loadButton.addEventListener("click", () => {
    fileInput.click();
  });

  // When the user selects a file, read it and load its content into the story div
  fileInput.addEventListener("change", (event) => {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        // Set the content of the "story" div to the text file's content
        document.getElementById("story").textContent = e.target.result;
        makeWordsClickable('story', handleWordClick);
      };
      reader.onerror = function() {
        console.error("Error reading file");
      };
      // Read the file as plain text
      reader.readAsText(file);
    }
  });
</script>

</body>
</html>
