<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Somebody or Anybody?</title>
  <style>
    /* Old PC / Terminal styling */
    body {
      background-color: black;
      color: #00ff00; /* bright green text */
      font-family: monospace;
      margin: 0;
      padding: 0;
    }
    #container {
      width: 90%;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      border: 2px solid #00ff00;
    }
    h1, h2, h3 {
      color: #00ff00;
      margin: 0 0 10px;
    }
    #intro, #game-area {
      margin-bottom: 20px;
    }
    /* Buttons */
    .green-btn {
      background-color: black;
      color: #00ff00;
      font-family: monospace;
      border: 1px solid #00ff00;
      padding: 8px 16px;
      margin: 5px;
      cursor: pointer;
    }
    .green-btn:hover {
      background-color: #003300;
    }
    /* Text display area */
    #story {
      white-space: pre-line;
      margin-top: 20px;
      line-height: 1.4;
      border: 1px dashed #00ff00;
      padding: 10px;
      min-height: 150px;
    }
    /* Input fields */
    input {
      background-color: black;
      color: #00ff00;
      border: 1px solid #00ff00;
      font-family: monospace;
      padding: 5px;
      margin: 5px 0;
      width: 400px;
    }
  </style>
</head>
<body>
  <div id="container">
    <h1>Somebody or Anybody?</h1>
    <h2>Space Adventure</h2>

    <div id="intro">
      <p>Enter your key and click "Start Game" to begin. </p>
      <input id="pat" placeholder="Enter your key" />
      <br>
      <button class="green-btn" onclick="startGame()">Start Game</button>
    </div>

    <div id="game-area" style="display:none;">
      <div id="story"></div>
      <div>
        <button class="green-btn" onclick="playerChoice('somebody')">somebody</button>
        <button class="green-btn" onclick="playerChoice('anybody')">anybody</button>
      </div>
    </div>
  </div>

  <script>
    // We'll store the conversation with the AI in this array of messages.
    // The system prompt instructs the AI to act as a text-based game about
    // "somebody" vs. "anybody".
    let messages = [];

    // Replace with your actual endpoint & model details if different:
    const endpoint = 'https://models.inference.ai.azure.com/openai/deployments/gpt-4o/chat/completions?api-version=2024-02-15-preview';
    // The model name is also required in the header for Azure.
    const modelHeader = { 'x-ms-model-mesh-model-name': 'gpt-4o' };

    let pat = '';

    function startGame() {
      // Get the user's PAT from the input field
      pat = document.getElementById('pat').value.trim();
      if (!pat) {
        alert("Please enter your Azure OpenAI PAT!");
        return;
      }

      // Show the game area
      document.getElementById('game-area').style.display = 'block';

      // Initialize messages with a system instruction
      messages = [
        {
          role: 'system',
          content: `You are a text-based game engine for learning the difference between "somebody" and "anybody" in English. 
- The setting is a space adventure.
- Don't create fealing that it's learners material, make it feels more like real game.
- For A0-A2 learners. Keep it simple.
- The user can only answer "somebody" or "anybody".
- If the user chooses correctly, the story remains comedic/fun. 
- If the user chooses incorrectly, the story becomes dark/creepy, possibly leading to the user's dead.
- At each step, you must continue the story and ask the user for the next choice.
- The game ends if the user dies or if the story concludes successfully. 
Let's begin. Provide the first scenario now.`
        }
      ];

      // Call AI for the first scenario
      callOpenAI()
        .then(responseText => {
          document.getElementById('story').textContent = responseText;
        })
        .catch(err => {
          document.getElementById('story').textContent = "Error starting game: " + err;
        });
    }

    async function playerChoice(choice) {
      // Add the user's choice to the conversation
      messages.push({
        role: 'user',
        content: choice
      });

      // Call the AI to get the next part of the story
      try {
        const responseText = await callOpenAI();
        // Display AI's new response
        document.getElementById('story').textContent = responseText;
      } catch (err) {
        document.getElementById('story').textContent = "Error continuing game: " + err;
      }
    }

    async function callOpenAI() {
      // Make a call to Azure OpenAI with the current conversation
      const bodyData = {
        messages: messages,
        temperature: 1,
        max_tokens: 1024,
        top_p: 1
      };

      const response = await fetch(endpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + pat,
          ...modelHeader
        },
        body: JSON.stringify(bodyData)
      });

      const data = await response.json();

      if (data.error) {
        throw new Error(JSON.stringify(data.error));
      }

      if (!data.choices || data.choices.length === 0) {
        throw new Error("No response from AI");
      }

      const aiMessage = data.choices[0].message.content;

      // Add AI response to the conversation
      messages.push({
        role: 'assistant',
        content: aiMessage
      });

      return aiMessage;
    }
  </script>
</body>
</html>
