<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Video & SRT Archive Creator</title>
</head>
<body>
  <h1>Upload Video and SRT File</h1>
  <input type="file" id="videoInput" accept="video/*">
  <input type="file" id="srtInput" accept=".srt">
  <button id="processButton">Process Files</button>
  <br><br>
  <a id="downloadLink" style="display:none;">Download Archive</a>

  <!-- Include JSZip library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script>
    // Global JSON archive object that will be structured as:
    // {
    //   "word": {
    //     "examples": [ {text, video, start, end}, ... ],
    //     "rating": 0,
    //     "ignored": false
    //   },
    //   ...
    // }
    let archive = {};

    // Parse the SRT file content into subtitle blocks
    function parseSRT(srtText) {
      // Split the SRT file into blocks by blank lines
      const blocks = srtText.trim().split(/\n\s*\n/);
      let subtitles = [];
      blocks.forEach(block => {
        const lines = block.split('\n');
        if (lines.length < 3) return; // not enough lines for a valid subtitle block

        // Extract time information from the second line
        const timeMatch = lines[1].match(/(\d{2}:\d{2}:\d{2},\d{3})\s*-->\s*(\d{2}:\d{2}:\d{2},\d{3})/);
        if (!timeMatch) return;
        const start = toSeconds(timeMatch[1]);
        const end = toSeconds(timeMatch[2]);

        // Combine the remaining lines as the subtitle text
        const text = lines.slice(2).join(' ');
        subtitles.push({ start, end, text });
      });
      return subtitles;
    }

    // Convert time in SRT format (hh:mm:ss,ms) to seconds (as a float)
    function toSeconds(timeStr) {
      const parts = timeStr.split(/[:,]/);
      return (+parts[0]) * 3600 + (+parts[1]) * 60 + (+parts[2]) + (+parts[3]) / 1000;
    }

    // Update the JSON archive using the subtitles and video file name.
    function updateArchive(subtitles, videoFileName) {
      subtitles.forEach(sub => {
        // Build the example object for this subtitle block
        const exampleObj = {
          text: sub.text,
          video: videoFileName,
          start: sub.start,
          end: sub.end
        };

        // Extract words from the text for the keys.
        // Convert to lowercase and extract words (letters, digits, and underscores)
        const words = sub.text.toLowerCase().match(/\b\w+\b/g);
        if (words) {
          // Use a Set to avoid adding the same subtitle example multiple times for a single word.
          const uniqueWords = Array.from(new Set(words));
          uniqueWords.forEach(word => {
            if (!archive[word]) {
              archive[word] = {
                examples: [],
                rating: 0,
                ignored: false
              };
            }
            archive[word].examples.push(exampleObj);
          });
        }
      });
    }

    // Create a ZIP archive containing the video, SRT, and the JSON archive
    function createZipArchive(videoFile, srtFile, archiveJSON) {
      const zip = new JSZip();
      // Add the video and SRT files as-is
      zip.file(videoFile.name, videoFile);
      zip.file(srtFile.name, srtFile);
      // Add the JSON archive file (formatted with indentation)
      zip.file("archive.json", JSON.stringify(archiveJSON, null, 2));

      // Generate the ZIP file and create a download link
      zip.generateAsync({ type: "blob" })
      .then(function(content) {
        const downloadLink = document.getElementById('downloadLink');
        downloadLink.href = URL.createObjectURL(content);
        downloadLink.download = "archive.zip";
        downloadLink.style.display = "block";
        downloadLink.innerText = "Download Archive";
      });
    }

    // Process the files when the button is clicked
    document.getElementById('processButton').addEventListener('click', () => {
      const videoInput = document.getElementById('videoInput');
      const srtInput = document.getElementById('srtInput');

      if (videoInput.files.length === 0 || srtInput.files.length === 0) {
        alert("Please select both a video and an SRT file.");
        return;
      }

      const videoFile = videoInput.files[0];
      const srtFile = srtInput.files[0];

      // Read the SRT file content
      const reader = new FileReader();
      reader.onload = function(e) {
        const srtText = e.target.result;
        const subtitles = parseSRT(srtText);
        updateArchive(subtitles, videoFile.name);
        console.log("Generated Archive:", archive);
        // Create a downloadable ZIP containing the video, SRT, and JSON archive
        createZipArchive(videoFile, srtFile, archive);
      };
      reader.readAsText(srtFile);
    });
  </script>
</body>
</html>
