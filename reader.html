<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Reader</title>
  <link rel="stylesheet" href="reading.css">
</head>
<body>
  <div id="container">
    <h1>Reader</h1>
    
    <div id="intro">
      <p>Enter your Azure API key.</p>
      <input id="pat" placeholder="Enter your Azure OpenAI PAT" />
    </div>
    
    <div id="game-area">
      <div id="story"></div>
      <button type="button">Load book.</button>
    </div>
  </div>

  <!-- Inline JavaScript to load text file content into the story div -->
   <script type="module">
  import { makeWordsClickable } from './clickableWords.js';
  import { callOpenAI } from './openaiCaller.js';

function fuu(word) {
    if ('speechSynthesis' in window) {
        let utterance = new SpeechSynthesisUtterance(word);
        
        // Auto-detect language using regex (basic detection)
        if (/[\u0400-\u04FF]/.test(word)) {
            utterance.lang = 'ru-RU'; // Russian
        } else if (/[\u4E00-\u9FFF]/.test(word)) {
            utterance.lang = 'zh-CN'; // Chinese
        } else if (/[\u0600-\u06FF]/.test(word)) {
            utterance.lang = 'ar-SA'; // Arabic
        } else {
            utterance.lang = 'en-US'; // Default to English
        }

        window.speechSynthesis.speak(utterance);
    } else {
        alert("Speech synthesis not supported in your browser.");
    }
}

function showAlertWithMeaning(word, meaning) {
    let modal = document.createElement("div");
    modal.style.position = "fixed";
    modal.style.top = "50%";
    modal.style.left = "50%";
    modal.style.transform = "translate(-50%, -50%)";
    modal.style.padding = "20px";
    modal.style.backgroundColor = "white";
    modal.style.border = "2px solid black";
    modal.style.boxShadow = "0px 4px 6px rgba(0, 0, 0, 0.1)";
    modal.style.zIndex = "1000";
    modal.style.textAlign = "center";

    let text = document.createElement("p");
    text.innerHTML = `<strong>${word}</strong>: ${meaning}`;
    modal.appendChild(text);

    let playButton = document.createElement("button");
    playButton.textContent = "ðŸ”Š Play";
    playButton.onclick = function() {
        fuu(word);
    };
    modal.appendChild(playButton);

    let closeButton = document.createElement("button");
    closeButton.textContent = "Close";
    closeButton.style.marginLeft = "10px";
    closeButton.onclick = function() {
        document.body.removeChild(modal);
    };
    modal.appendChild(closeButton);

    document.body.appendChild(modal);
}


  async function getResponse(word, context) {
    // Assuming "pat" is an input field, use .value
    const pat = document.getElementById("pat").value;
    const messages = [
      {
        role: 'system',
        content: `You are a dictionary. Explain meaning of this word or words inside this exact context.
It should be A0-A1 explanation like for kids but it's for adult. Add IPA.`
      },
      {
        role: 'user',
        content: `Word: "${word}" Context: "${context}"`
      }
    ];

    try {
      const aiMessage = await callOpenAI(messages, pat);
      showAlertWithMeaning("${word}", `${aiMessage}`);
    } catch (err) {
      alert(`${err}`);
    }
  }

  function handleWordClick(clickedWord, context) {
    getResponse(clickedWord, context);
  }

  // Find the button element on the page
  const loadButton = document.querySelector("button");

  // Create a hidden file input element
  const fileInput = document.createElement("input");
  fileInput.type = "file";
  fileInput.accept = ".txt"; // Accept only text files
  fileInput.style.display = "none"; // Hide the element

  // Append the file input to the document body so it can work properly
  document.body.appendChild(fileInput);

  // When the button is clicked, simulate a click on the file input
  loadButton.addEventListener("click", () => {
    fileInput.click();
  });

  // When the user selects a file, read it and load its content into the story div
  fileInput.addEventListener("change", (event) => {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        // Set the content of the "story" div to the text file's content
        document.getElementById("story").textContent = e.target.result;
        makeWordsClickable('story', handleWordClick);
      };
      reader.onerror = function() {
        console.error("Error reading file");
      };
      // Read the file as plain text
      reader.readAsText(file);
    }
  });
</script>

</body>
</html>
