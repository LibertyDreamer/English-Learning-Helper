<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Somebody or Anybody? - AI-Powered Text Game</title>
  <style>
    /* Old PC / Terminal styling */
    body {
      background-color: black;
      color: #00ff00; /* bright green text */
      font-family: monospace;
      margin: 0;
      padding: 0;
    }
    #container {
      width: 90%;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      border: 2px solid #00ff00;
    }
    h1, h2, h3 {
      color: #00ff00;
      margin: 0 0 10px;
    }
    #intro, #game-area {
      margin-bottom: 20px;
    }
    /* Buttons and Inputs */
    .green-btn {
      background-color: black;
      color: #00ff00;
      font-family: monospace;
      border: 1px solid #00ff00;
      padding: 8px 16px;
      margin: 5px;
      cursor: pointer;
    }
    .green-btn:hover {
      background-color: #003300;
    }
    input[type="text"] {
      background-color: black;
      color: #00ff00;
      border: 1px solid #00ff00;
      font-family: monospace;
      padding: 5px;
      margin: 5px 0;
      width: 400px;
    }
    /* Text display area */
    #story {
      white-space: pre-line;
      margin-top: 20px;
      line-height: 1.4;
      border: 1px dashed #00ff00;
      padding: 10px;
      min-height: 150px;
    }
    /* Make every token clickable for definitions */
    .word {
      cursor: pointer;
      text-decoration: underline;
    }
    .word:hover {
      background-color: #003300;
    }
  </style>
</head>
<body>
  <div id="container">
    <h1>Somebody or Anybody?</h1>
    <h2>AI-Powered Space Text Adventure</h2>

    <div id="intro">
      <p>
        Enter your Azure OpenAI PAT (or API key) and click "Start Game" to begin.<br>
        Each time, type a sentence containing <strong>“somebody”</strong> or <strong>“anybody”</strong>.<br>
        <strong>Click any word</strong> in the story to see a short, kid-friendly definition from the AI!
      </p>
      <input id="pat" placeholder="Enter your Azure OpenAI PAT" />
      <br>
      <button class="green-btn" onclick="startGame()">Start Game</button>
    </div>

    <div id="game-area" style="display:none;">
      <div id="story"></div>
      <div style="margin-top:10px;">
        <input type="text" id="player-input" placeholder="Type a sentence using 'somebody' or 'anybody'">
        <button class="green-btn" onclick="sendPlayerInput()">Send</button>
      </div>
    </div>
  </div>

  <script>
    /********************************************************
     * 1) CONFIG & GLOBALS
     ********************************************************/
    // Azure OpenAI endpoint (replace if needed)
    const endpoint = 'https://models.inference.ai.azure.com/openai/deployments/gpt-4o/chat/completions?api-version=2024-02-15-preview';
    // Model name header required by Azure
    const modelHeader = { 'x-ms-model-mesh-model-name': 'gpt-4o' };

    // We'll store the conversation with the AI in this array of messages.
    // This is the "game" memory so the AI remembers the story.
    let messages = [];
    let pat = ''; // We'll store the user's PAT

    /********************************************************
     * 2) START GAME
     ********************************************************/
    function startGame() {
      pat = document.getElementById('pat').value.trim();
      if (!pat) {
        alert("Please enter your Azure OpenAI PAT!");
        return;
      }

      document.getElementById('game-area').style.display = 'block';

      // Set up the system instruction with your custom request
      messages = [
        {
          role: 'system',
          content: `You are a text-based game engine for learning the difference between "somebody" and "anybody" in English. 
- The setting is a comedic and dark space adventure.
- The user must type a sentence containing the learning words."
- Every time then user make right or wrong desition between learning words make it obviously throught the story! 
somehow add explanation why it was grammatically correct or not, but don't explain straight, and include it inside story like it's a part of that story.
- I want this game feels like real game, not like grammar test or something!
- Vocabulary like for 3 years old kid. But the game for grown ups. Ultraviolence is included!!!
- If they use the correct usage in context, continue the story in a fun, light-hearted way.
- If they use the wrong usage, continue the story in a dark, creepy way, possibly leading to their demise.
- Always end your response with a prompt asking them to type another sentence with "somebody" or "anybody," unless the game is over.
- Keep track of the storyline in one session.`
        },
        {
          role: 'user',
          content: `Hello! Start the game now.`
        }
      ];

      // Get the first AI response (story introduction)
      callOpenAI(messages)
        .then(responseText => {
          updateStory(responseText);
        })
        .catch(err => {
          document.getElementById('story').textContent = "Error: " + err;
        });
    }

    /********************************************************
     * 3) PLAYER INPUT
     ********************************************************/
    function sendPlayerInput() {
      const inputField = document.getElementById('player-input');
      const userSentence = inputField.value.trim();
      if (!userSentence) {
        alert("Please type a sentence containing 'somebody' or 'anybody'.");
        return;
      }

      // Add the user's sentence as a new user message
      messages.push({
        role: 'user',
        content: userSentence
      });

      inputField.value = ''; // clear the input

      // Call the AI for the next part of the story
      callOpenAI(messages)
        .then(responseText => {
          updateStory(responseText);
        })
        .catch(err => {
          document.getElementById('story').textContent = "Error: " + err;
        });
    }

    /********************************************************
     * 4) CLICK-TO-DEFINE (ON ANY WORD)
     ********************************************************/
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('word')) {
        const clickedWord = e.target.getAttribute('data-word');
        // Make a separate request to the AI for a definition of that word
        defineWord(clickedWord);
      }
    });

    async function defineWord(word) {
      try {
        const definitionConversation = [
          {
            role: 'system',
            content: 'You are a dictionary. Provide a short, kid-friendly definition for the given word.'
          },
          {
            role: 'user',
            content: `Define: "${word}" for a 4-year-old.`
          }
        ];
        const defText = await callOpenAI(definitionConversation);
        alert(`Definition of "${word}":\n\n${defText}`);
      } catch (err) {
        alert("Error getting definition: " + err);
      }
    }

    /********************************************************
     * 5) CALL AZURE OPENAI
     ********************************************************/
    async function callOpenAI(convArray) {
      const bodyData = {
        messages: convArray,
        temperature: 1,
        max_tokens: 1024,
        top_p: 1
      };

      const response = await fetch(endpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + pat,
          ...modelHeader
        },
        body: JSON.stringify(bodyData)
      });

      const data = await response.json();

      if (data.error) {
        throw new Error(JSON.stringify(data.error));
      }
      if (!data.choices || data.choices.length === 0) {
        throw new Error("No response from AI");
      }

      const aiMessage = data.choices[0].message.content;
      // Add AI's response to the conversation if it's the main game conversation
      if (convArray === messages) {
        messages.push({
          role: 'assistant',
          content: aiMessage
        });
      }
      return aiMessage;
    }

    /********************************************************
     * 6) SHOWING THE STORY WITH CLICKABLE WORDS
     ********************************************************/
    function updateStory(aiText) {
      // We'll wrap each token in <span class="word" data-word="...">
      // This is a naive approach to split on whitespace. Punctuation may attach to words.
      // For a quick example, it's fine. Real usage might need more robust tokenization.
      const wrapped = parseAndWrapWords(aiText);
      const storyDiv = document.getElementById('story');
      storyDiv.innerHTML = wrapped; // Insert as HTML
    }

    function parseAndWrapWords(text) {
      // Simple split on spaces
      const tokens = text.split(/\s+/);
      const wrappedTokens = tokens.map(token => {
        // We'll remove punctuation from the data-word, but keep it in display
        // So that clicking "dark..." => data-word="dark"
        const cleanToken = token.replace(/[.,!?]+$/, '');
        return `<span class="word" data-word="${cleanToken}">${token}</span>`;
      });
      return wrappedTokens.join(" ");
    }
  </script>
</body>
</html>
