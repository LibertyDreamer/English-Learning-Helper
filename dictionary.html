<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Word Drill System</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .section {
      border: 1px solid #ccc;
      padding: 15px;
      margin-bottom: 20px;
    }
    textarea {
      width: 100%;
      height: 150px;
      font-family: monospace;
    }
    button {
      margin: 5px;
      padding: 5px 10px;
    }
    #wordDisplay {
      margin-bottom: 10px;
    }
    #currentWord {
      font-size: 1.5em;
      margin-bottom: 10px;
    }
    #exampleDisplay {
      padding: 10px;
      border: 1px solid #999;
      min-height: 40px;
      margin-bottom: 10px;
    }
    .ratingBtn {
      margin: 3px;
    }
  </style>
</head>
<body>
  <h1>Word Drill System</h1>
  
  <div class="section" id="input-section">
    <h2>Input Text and Load JSON</h2>
    <p>Paste your ASS, SRT or plain text below:</p>
    <textarea id="inputText" placeholder="Paste text here..."></textarea>
    <br>
    <button id="processTextBtn">Process Text</button>
    <br><br>
    <label for="jsonFileInput">Load existing JSON file:</label>
    <input type="file" id="jsonFileInput" accept=".json">
    <button id="loadJsonBtn">Load JSON</button>
  </div>
  
  <div class="section" id="drill-section" style="display:none;">
    <h2>Drill System</h2>
    <div id="wordDisplay">
      <h3 id="currentWord"></h3>
      <div id="exampleDisplay"></div>
      <button id="nextExampleBtn">Next Example</button>
      <button id="listenExampleBtn">Listen Example</button>
      <button id="ignoreWordBtn">Ignore Word</button>
    </div>
    <div id="ratingSection">
      <p>How well do you know this word?</p>
      <button class="ratingBtn" data-rating="0">0%</button>
      <button class="ratingBtn" data-rating="20">20%</button>
      <button class="ratingBtn" data-rating="40">40%</button>
      <button class="ratingBtn" data-rating="60">60%</button>
      <button class="ratingBtn" data-rating="80">80%</button>
      <button class="ratingBtn" data-rating="100">100%</button>
    </div>
    <button id="nextWordBtn">Next Word</button>
  </div>
  
  <div class="section" id="download-section" style="display:none;">
    <h2>Download Updated JSON</h2>
    <button id="downloadJsonBtn">Download JSON</button>
  </div>
  
  <!-- JavaScript in module mode -->
  <script type="module">
    /*******************
     * Speech Module
     *******************/
    const availableVoices = [
      "Matthew", "Joanna", "Kimberly", "Salli", 
      "Amy", "Emma", "Brian", "Russell"
    ];
    
    /**
     * Converts text to speech using StreamElements API.
     *
     * @param {string} text - The text to be spoken.
     * @param {string} [voice="Salli"] - The voice to use.
     */
    async function sayThis(text, voice = "Salli") {
      if (!text) {
          console.error("No text provided.");
          return;
      }
  
      if (!availableVoices.includes(voice)) {
          console.warn(`Invalid voice "${voice}". Defaulting to "Salli".`);
          voice = "Salli";
      }
  
      const ttsUrl = `https://api.streamelements.com/kappa/v2/speech?voice=${voice}&text=` + encodeURIComponent(text);
  
      try {
          const audio = new Audio(ttsUrl);
          await audio.play();
      } catch (error) {
          console.error("TTS Error:", error);
      }
    }
    
    /**
     * Returns a list of available voices.
     */
    function getAvailableVoices() {
      return availableVoices;
    }
    
    /*******************
     * Drill System Code
     *******************/
    
    // Global variables for JSON data and drill state.
    let wordData = {}; // { word: { examples: [...], percentage: <number> } }
    let words = [];    // Array of words (keys from wordData)
    let ignoredWords = []; // Words to be ignored in the drill system.
    let currentWord = "";
    let currentExamples = [];
    let exampleIndex = 0;
    
    // Process input text: detect if it's ASS, SRT, or plain text.
    function processInputText(text) {
      let processedLines = [];
      text = text.trim();
      // ASS detection: if any line starts with "Dialogue:"
      if(text.includes("Dialogue:")) {
        const lines = text.split("\n");
        for(const line of lines) {
          if(line.startsWith("Dialogue:")) {
            const parts = line.split(",", 10); // ASS dialogue: text is after 9 commas
            if(parts.length >= 10) {
              let dialogue = parts[9].trim();
              // Remove formatting tags (e.g., {\\move(...)} )
              dialogue = dialogue.replace(/\{[^}]*\}/g, "").trim();
              if(dialogue) processedLines.push(dialogue);
            }
          }
        }
      } else if(text.match(/^\d+\s*\n\d\d:\d\d:\d\d/)) {
        // SRT detection: block starts with a number then a timestamp.
        const blocks = text.split(/\n\s*\n/);
        for(const block of blocks) {
          const lines = block.split("\n");
          if(lines.length >= 3) {
            // Join lines after the first two (number and timestamp)
            const dialogue = lines.slice(2).join(" ").trim();
            if(dialogue) processedLines.push(dialogue);
          }
        }
      } else {
        // Otherwise, assume plain text: each line is taken.
        processedLines = text.split("\n").map(line => line.trim()).filter(line => line);
      }
      return processedLines;
    }
    
    // Clean a line by removing any formatting tags.
    function cleanLine(line) {
      return line.replace(/\{[^}]*\}/g, "").trim();
    }
    
    // Update wordData with examples extracted from lines.
    function updateWordDataFromLines(lines) {
      lines.forEach(line => {
        // Clean line to remove formatting tags.
        line = cleanLine(line);
        if(isVectorCommand(line)) return; // Skip vector drawing commands.
        // Extract words (letters/numbers) in lowercase.
        const wordsInLine = line.toLowerCase().match(/\w+/g);
        if(wordsInLine) {
          wordsInLine.forEach(word => {
            if(!wordData[word]) {
              wordData[word] = { examples: [line], percentage: 0 };
            } else {
              if(!wordData[word].examples.includes(line)) {
                wordData[word].examples.push(line);
              }
            }
          });
        }
      });
      words = Object.keys(wordData);
    }
    
    // Check if text is likely a vector drawing command (only drawing tokens and numbers).
    function isVectorCommand(text) {
      const tokens = text.trim().split(/\s+/);
      for(let token of tokens) {
        if(/^(m|l|c|s|n)$/i.test(token)) continue;
        if(/^\d+(\.\d+)?$/.test(token)) continue;
        return false;
      }
      return true;
    }
    
    // Select a random word that is not ignored.
    function selectRandomWord() {
      const validWords = words.filter(word => !ignoredWords.includes(word));
      if(validWords.length === 0) return null;
      let randIndex = Math.floor(Math.random() * validWords.length);
      return validWords[randIndex];
    }
    
    // Show the current word and a random example.
    function showCurrentWord() {
      if(!currentWord) return;
      document.getElementById("currentWord").innerText = currentWord;
      currentExamples = wordData[currentWord].examples;
      exampleIndex = Math.floor(Math.random() * currentExamples.length);
      document.getElementById("exampleDisplay").innerText = currentExamples[exampleIndex];
    }
    
    // Attempt to pick a new word different from the current one.
    function pickNextWord() {
      let newWord = selectRandomWord();
      // If possible, try to avoid repeating the same word.
      let attempts = 0;
      while(newWord === currentWord && attempts < 10) {
        newWord = selectRandomWord();
        attempts++;
      }
      return newWord;
    }
    
    // Event: Process Text button.
    document.getElementById("processTextBtn").addEventListener("click", function() {
      const inputText = document.getElementById("inputText").value;
      if(!inputText) {
        alert("Please paste some text first.");
        return;
      }
      const lines = processInputText(inputText);
      updateWordDataFromLines(lines);
      alert("Text processed. Words updated in JSON data.");
      if(Object.keys(wordData).length > 0) {
        document.getElementById("drill-section").style.display = "block";
        document.getElementById("download-section").style.display = "block";
        currentWord = pickNextWord();
        showCurrentWord();
      }
    });
    
    // Event: Load JSON button.
    document.getElementById("loadJsonBtn").addEventListener("click", function() {
      const fileInput = document.getElementById("jsonFileInput");
      if(fileInput.files.length === 0) {
        alert("Please select a JSON file to load.");
        return;
      }
      const file = fileInput.files[0];
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          wordData = JSON.parse(e.target.result);
          words = Object.keys(wordData);
          alert("JSON file loaded successfully.");
          document.getElementById("drill-section").style.display = "block";
          document.getElementById("download-section").style.display = "block";
          currentWord = pickNextWord();
          showCurrentWord();
        } catch(err) {
          alert("Error parsing JSON file.");
        }
      };
      reader.readAsText(file);
    });
    
    // Event: Next Example button.
    document.getElementById("nextExampleBtn").addEventListener("click", function() {
      if(currentExamples.length === 0) return;
      exampleIndex = (exampleIndex + 1) % currentExamples.length;
      document.getElementById("exampleDisplay").innerText = currentExamples[exampleIndex];
    });
    
    // Event: Listen Example button using provided TTS module.
    document.getElementById("listenExampleBtn").addEventListener("click", function() {
      const text = document.getElementById("exampleDisplay").innerText;
      sayThis(text).catch(err => console.error(err));
    });
    
    // Event: Ignore Word button – add current word to ignore list.
    document.getElementById("ignoreWordBtn").addEventListener("click", function() {
      if(currentWord) {
        if(!ignoredWords.includes(currentWord)) {
          ignoredWords.push(currentWord);
          alert(`Ignored word: ${currentWord}`);
        }
        // Pick a new word after ignoring.
        currentWord = pickNextWord();
        if(currentWord) {
          showCurrentWord();
        } else {
          document.getElementById("currentWord").innerText = "No more words available.";
          document.getElementById("exampleDisplay").innerText = "";
        }
      }
    });
    
    // Event: Rating buttons – update current word's percentage.
    document.querySelectorAll(".ratingBtn").forEach(btn => {
      btn.addEventListener("click", function() {
        const rating = parseInt(btn.getAttribute("data-rating"));
        if(currentWord && wordData[currentWord]) {
          wordData[currentWord].percentage = rating;
          alert(`Updated ${currentWord} rating to ${rating}%`);
        }
      });
    });
    
    // Event: Next Word button.
    document.getElementById("nextWordBtn").addEventListener("click", function() {
      currentWord = pickNextWord();
      if(currentWord) {
        showCurrentWord();
      } else {
        document.getElementById("currentWord").innerText = "No words available for drill.";
        document.getElementById("exampleDisplay").innerText = "";
      }
    });
    
    // Event: Download JSON button.
    document.getElementById("downloadJsonBtn").addEventListener("click", function() {
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(wordData, null, 2));
      const downloadAnchor = document.createElement("a");
      downloadAnchor.setAttribute("href", dataStr);
      downloadAnchor.setAttribute("download", "updated_words.json");
      document.body.appendChild(downloadAnchor);
      downloadAnchor.click();
      downloadAnchor.remove();
    });
  </script>
</body>
</html>
